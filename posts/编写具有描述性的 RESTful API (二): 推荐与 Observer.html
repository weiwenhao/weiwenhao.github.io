<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 编写具有描述性的 RESTful API (二): 推荐与 Observer · weiwenhao</title><meta name="description" content="编写具有描述性的 RESTful API (二): 推荐与 Observer - 粤ICP备18153286"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://beian.miit.gov.cn/atom.xml" title="weiwenhao"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/weiwenhao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">编写具有描述性的 RESTful API (二): 推荐与 Observer</h1><div class="post-info">2019年3月16日</div><div class="post-content"><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><h4 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h4><p>接上一篇提到的,通过专题( collection ), 来实现推荐阅读的编写. </p>
<p>按照惯例,先来看看 <a href="https://www.jianshu.com/c/yD9GAd" target="_blank" rel="noopener">专题的设计稿</a> ,然后设计出表结构.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Schema::create(<span class="string">'collections'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">    $table-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">    $table-&gt;string(<span class="string">'name'</span>);</span><br><span class="line">    $table-&gt;string(<span class="string">'avatar'</span>);</span><br><span class="line">    $table-&gt;string(<span class="string">'description'</span>);</span><br><span class="line"></span><br><span class="line">    $table-&gt;unsignedInteger(<span class="string">'post_count'</span>)-&gt;default(<span class="number">0</span>);</span><br><span class="line">    $table-&gt;unsignedInteger(<span class="string">'fans_count'</span>)-&gt;default(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    $table-&gt;unsignedInteger(<span class="string">'user_id'</span>)-&gt;comment(<span class="string">'创建者'</span>);</span><br><span class="line"></span><br><span class="line">    $table-&gt;timestamps();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>专题存在管理员( collection_admin )/投稿作者( collection_author )/关注者( collection_follower ) /帖子( collection_post ) 此处以 collection_post 为例看一下中间表的设计,其是 collection 和 post 中间表. </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Schema::create(<span class="string">'collection_post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">    $table-&gt;unsignedInteger(<span class="string">'post_id'</span>);</span><br><span class="line">    $table-&gt;unsignedInteger(<span class="string">'collection_id'</span>);</span><br><span class="line"></span><br><span class="line">    $table-&gt;timestamp(<span class="string">'passed_at'</span>)-&gt;nullable()-&gt;comment(<span class="string">'审核通过时间'</span>);</span><br><span class="line"></span><br><span class="line">    $table-&gt;timestamps();</span><br><span class="line"></span><br><span class="line">    $table-&gt;index(<span class="string">'post_id'</span>);</span><br><span class="line">    $table-&gt;index(<span class="string">'collection_id'</span>);</span><br><span class="line"></span><br><span class="line">    $table-&gt;unique([<span class="string">'post_id'</span>, <span class="string">'collection_id'</span>]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>建好表之后记得填充 seeder 哦.</p>
<h4 id="建模"><a href="#建模" class="headerlink" title="建模"></a>建模</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Collection.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(Post::class, <span class="string">'collection_post'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Post.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">collections</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(Collection::class, <span class="string">'collection_post'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了 Collection ,接下来就能够实现<a href="https://www.jianshu.com/p/aff99d1d194b" target="_blank" rel="noopener">帖子详情页设计稿</a>的最后一部分啦</p>
<h4 id="专题收入"><a href="#专题收入" class="headerlink" title="专题收入"></a>专题收入</h4><p><img src="https://cdn.learnku.com/uploads/images/201903/16/10960/rjECrWLfwf.png!large" alt></p>
<p>首先是专题收录部分, 按照 RESTful 的规范,我们可以设计出这样一条 API</p>
<p><a href="http://community.eienao.com/api/posts/1/collections" target="_blank" rel="noopener">test.com/api/posts/{post}/collections</a> , 此处编码较为简单,参考源码即可</p>
<h4 id="推荐阅读-1"><a href="#推荐阅读-1" class="headerlink" title="推荐阅读"></a>推荐阅读</h4><p><img src="https://cdn.learnku.com/uploads/images/201903/16/10960/WNg6e2hcm1.png!large" alt></p>
<p>首先还是按照 RESTful 规范 来设计 API</p>
<p><a href="http://community.eienao.com/api/posts/1/recommend-posts?include=user" target="_blank" rel="noopener">test.com/api/posts/{post}/recommend-posts?include=user</a></p>
<p>相应的控制器代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PostController.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">indexOfRecommend</span><span class="params">($post)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $collectionIds = $post-&gt;collections()-&gt;pluck(<span class="string">'id'</span>);</span><br><span class="line"></span><br><span class="line">    $query = Post::whereHas(<span class="string">'collections'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($collectionIds)</span> </span>&#123;</span><br><span class="line">        $query-&gt;whereIn(<span class="string">'collection_id'</span>, $collectionIds);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 排序问题</span></span><br><span class="line">    $posts = $query-&gt;columns()-&gt;paginate();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PostResource::make($posts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要说明一下, <strong>laravel 提供的 whereHas 会生成一个效率不高的 SQL 语句</strong>,需要加载全表.但是系列的目的是编写具有描述性的 RESTful API ,所以此处不做进一步优化.</p>
<h2 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h2><p><a href="https://learnku.com/docs/laravel/5.7/eloquent/2294#observers" target="_blank" rel="noopener">Observer</a> 既 观察者,可以用于代码解耦,保持控制器简洁. 接下来的两个逻辑会涉及 Observer 的使用场景.</p>
<h4 id="热度"><a href="#热度" class="headerlink" title="热度"></a>热度</h4><p><code>$posts = $query-&gt;columns()-&gt;paginate();</code>  这行语句在没有指定 orderBy 时, MySQL 会按照 id , asc 的顺序取出帖子,但是在一般的社区网站中,通常会有一个热度,然后按照热度将帖子取出来.</p>
<p>这部分的排序算法又很多,按照产品给定的公式计算即可</p>
<blockquote>
<p>下文假定热度计算公式为 heat = a <em> (timestamp - 1546300800) + b </em> read_count + c * like_count</p>
<p>a/b/c 代表每一个特征所占的权重,可根据运营需求随时调整, 由于时间戳过大,所以通过 减去 2019-01-01的时间戳 1546300800 ,来缩小时间戳数字, 当然即使如此依旧会得到一个很大的数字,所以 a 的值会很小</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Schema::create(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    $table-&gt;integer(<span class="string">'heat'</span>)-&gt;index()-&gt;comment(<span class="string">'热度'</span>);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>由于项目在开发阶段,所以直接修改原有的 migration , 添加 heat 字段.然后执行 </p>
<p><code>&gt; php artisan migrate:refresh --seed</code></p>
<p>heat 字段的维护原则是,<strong>检测到 read_count 或者 like_count 发生变化时,则更新相关的热度.</strong>因此此处会用 observe来实现相关的功能.</p>
<p>按照文档创建观察者并注册后,可以编写相关的代码</p>
<p><code>&gt; php artisan make:observer PostObserver --model=Models/Post</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostObserver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Post $post</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saving</span><span class="params">(Post $post)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($post-&gt;isDirty([<span class="string">'like_count'</span>, <span class="string">'read_count'</span>])) &#123;</span><br><span class="line">            $heat = <span class="number">0.001</span> * ($post-&gt;created_at-&gt;timestamp - <span class="number">1546300800</span>)</span><br><span class="line">                + <span class="number">10</span> * $post-&gt;read_count</span><br><span class="line">                + <span class="number">1000</span> * $post-&gt;like_count;</span><br><span class="line">            </span><br><span class="line">            $post-&gt;heat = (integer)$heat;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 <code>$model-&gt;save/update/create</code> 都会在持久化到数据库之前触发 saving 方法.</p>
<h4 id="创建评论"><a href="#创建评论" class="headerlink" title="创建评论"></a>创建评论</h4><p>基础编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Comment</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Resources</span>\<span class="title">CommentResource</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Contracts\Routing\ResponseFactory|Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = $request-&gt;all();</span><br><span class="line"></span><br><span class="line">        $data[<span class="string">'user_id'</span>] = \Auth::id();</span><br><span class="line">        $data[<span class="string">'floor'</span>] = Comment::where(<span class="string">'post_id'</span>, $request-&gt;input(<span class="string">'post_id'</span>))-&gt;max(<span class="string">'floor'</span>) + <span class="number">1</span>;</span><br><span class="line">        $comment = Comment::create($data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RESTful 规范中,创建成功应该返回201状态码</span></span><br><span class="line">        <span class="keyword">return</span> \response(CommentResource::make($comment), <span class="number">201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Model</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Staudenmeir</span>\<span class="title">EloquentEagerLimit</span>\<span class="title">HasEagerLimit</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HasEagerLimit</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $fillable = [<span class="string">'content'</span>, <span class="string">'user_id'</span>, <span class="string">'post_id'</span>, <span class="string">'floor'</span>, <span class="string">'selected'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLikeCountAttribute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes[<span class="string">'like_count'</span>] ?? <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getReplyCountAttribute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes[<span class="string">'reply_count'</span>] ?? <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>由于使用了create 方法进行创建,因此需要在模型中声明 <code>$fillable</code></p>
<p>由于建表的时候为 like_count 和 reply_count 设定了默认值为 0 , 所以 <strong>在 create 时没有设定 like_count , reply_count</strong> .但是这样会造成<strong>控制器中的 store 方法中的 <code>$comment</code> 不存在 like_count , 和 reply_count 这两个 key , 这对前端是非常不友好的</strong>. 例如在 vue 中此处通常的做法是 <code>this.comments.push(comment)</code> .有两个办法解决这个问题</p>
<ul>
<li><p>create 时添加 <code>$data[&#39;like_count&#39;] = 0</code> 和 <code>$data[&#39;reply_count&#39;] = 0</code> </p>
</li>
<li><p>使用模型修改器设置这两个 key 的默认值(上面的 Comment 模型中演示了该方法)</p>
</li>
</ul>
<p>使用上述任意一种方法都能够<strong>保证查询与创建时的数据一致性.</strong></p>
<p>API 展示, 相应的 Postman 文档附加在文末</p>
<p><img src="https://cdn.learnku.com/uploads/images/201903/16/10960/QNK0NDm522.png!large" alt></p>
<p>在控制器代码中, 将相应的 Model 交给了 tree-ql 处理, 所以这里依旧可以使用 include , 从而保证相应数据一致性.</p>
<p> posts 表中冗余了 comment_count ,因此当创建一条评论时,还需要相应的 <code>post.comment_count + 1</code> . 创建并注册 CommentObserver. 然后完成相应的编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CommentObserver.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Observers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Comment</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentObserver</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">created</span><span class="params">(Comment $comment)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $comment-&gt;post()-&gt;increment(<span class="string">'comment_count'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h4 id="帖子的发布流程"><a href="#帖子的发布流程" class="headerlink" title="帖子的发布流程"></a>帖子的发布流程</h4><p>一个可能存在的问题是,一篇已经发布的帖子当用户想去再次修改它,此时如果修改到一半的帖子触发了自动保存机制,则会出现修改了一半的帖子被展示在首页等.</p>
<p>因此一张 posts 表并不能满足实际的需求,还需要增加一张 drafts 表来作为草稿箱, 用户的创建与修改操作都是在该表下进行的,只有用户点击发布时, 将相应的 drafts 同步到 posts 表即可. 相关流程参考简书即可.</p>
<p>发布流程编码示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DraftController.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">published</span><span class="params">(Draft $draft)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Validator::make($draft-&gt;getAttributes(), [</span><br><span class="line">        <span class="string">'title'</span> =&gt; <span class="string">'required|max:255'</span>,</span><br><span class="line">        <span class="string">'content'</span> =&gt; <span class="string">'required'</span></span><br><span class="line">    ])-&gt;validate();</span><br><span class="line"></span><br><span class="line">    $draft-&gt;published();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response(<span class="keyword">null</span>, <span class="number">201</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">published</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;post_id) &#123;</span><br><span class="line">        $post = Post::create([</span><br><span class="line">            <span class="string">'user_id'</span> =&gt; <span class="keyword">$this</span>-&gt;user_id,</span><br><span class="line">            <span class="string">'title'</span> =&gt; <span class="keyword">$this</span>-&gt;title,</span><br><span class="line">            <span class="string">'content'</span> =&gt; <span class="keyword">$this</span>-&gt;content,</span><br><span class="line">            <span class="string">'published_at'</span> =&gt; <span class="keyword">$this</span>-&gt;freshTimestampString(),</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;post_id = $post-&gt;id;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $post = Post::findOrFail(<span class="keyword">$this</span>-&gt;post_id);</span><br><span class="line">        $post-&gt;title = <span class="keyword">$this</span>-&gt;title;</span><br><span class="line">        $post-&gt;content = <span class="keyword">$this</span>-&gt;content;</span><br><span class="line">        $post-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其余部分参考源码,相关 API 参考 Postman 文档. </p>
<h4 id="相关"><a href="#相关" class="headerlink" title="相关"></a>相关</h4><ul>
<li>Api Document <a href="https://documenter.getpostman.com/view/1500624/S17nTVKL" target="_blank" rel="noopener">https://documenter.getpostman.com/view/1500624/S17nTVKL</a></li>
<li>线上调试工具 <a href="http://community.eienao.com/telescope" target="_blank" rel="noopener">telescope</a></li>
<li>本节源码 <a href="https://github.com/weiwenhao/community-api/tree/0.2.0-alpha" target="_blank" rel="noopener">weiwenhao/community-api</a></li>
<li>Api Tool <a href="https://github.com/weiwenhao/tree-ql" target="_blank" rel="noopener">weiwenhao/tree-ql</a></li>
<li>上一节 <a href="https://learnku.com/articles/25254" target="_blank" rel="noopener">编写具有描述性的 RESTful API (一): Workflow</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/posts/编写具有描述性的 RESTful API (三): 用户行为.html" class="prev">PREV</a><a href="/posts/编写具有描述性的 RESTful API (一): Workflow.html" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maxwei';
var disqus_identifier = 'posts/编写具有描述性的 RESTful API (二): 推荐与 Observer.html';
var disqus_title = '编写具有描述性的 RESTful API (二): 推荐与 Observer';
var disqus_url = 'http://beian.miit.gov.cn/posts/编写具有描述性的 RESTful API (二): 推荐与 Observer.html';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maxwei.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2020 <a href="http://beian.miit.gov.cn">粤ICP备18153286</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-113144905-1",'auto');ga('send','pageview');</script></body></html>